{% extends "base.html" %}
  
{% block content %}

<link rel="stylesheet" href="{{ MEDIA_URL }}/css/view_stats.css" type="text/css" media="screen" />
<link rel="stylesheet" href="{{ MEDIA_URL }}/css/results.css" type="text/css" media="screen" />

<script>
function hidediv( id ) { 
    document.getElementById(id).style.visibility = 'hidden';
    document.getElementById(id).style.display = 'none';
}
function getvalues(classname, fieldname) {
    obj = document.getElementById('classname');
    obj.value=classname;
    document.getElementById('fieldname').value=fieldname;
    
    document.forms["getusagestats"].submit(); 
}
function expandAll () {
    $("div.accordion").each(function(){
            $(this).next("div.filter").show(); 
    });
}
function collapseAll () {
    $("div.accordion").each(function(){
            $(this).next("div.filter").hide(); 
    });
}
</script>

<script language="javascript">
$(document).ready(function(){
  $("div.filter").each(function() {
    var allDds = $(this).children("div").not('.subresult').nextUntil("div.accordion");
    if (allDds.length > 4) {
	var hideableDds = allDds.has("a.addableFacet");
	if (hideableDds.length > 1) {
        hiddenDds = hideableDds.slice(
          Math.max(0, 4 - (allDds.length - hideableDds.length))).hide();
        var moreTxt = 'more', lessTxt = 'less';
        hiddenDds.last().after($("<div><a href='#'>" + moreTxt + "</a></div>")
            .children().first().click({hiddenDds: hiddenDds}, function(e) {
                e.preventDefault();
                $(this).text($(this).text() == moreTxt ? lessTxt : moreTxt);
                e.data.hiddenDds.slideToggle();
              }).parent());
      }
    }
  });
  $("div.filter").hide();
  $("div.accordion").each(function(){
      $(this).next("div.filter").find("a.removableFacet").parents("div.filter").show();
      addStatus($(this));
      $(this).next("div.filter").find("a.addFilter").parents("div.filter").show();
      addStatus($(this));
  });

  $("div.accordion.expanded").each(function(){
 	if( $(this).next("div.filter").find("a.removableFacet").length > 0 ){
 		$(this).addClass("selected");
 	}
 	if( $(this).next("div.filter").find("a.addFilter").length > 0 ){
 		$(this).addClass("selected");
 	}
  });

  $("div.accordion").click(function() {
      if($(this).next("div.filter").attr("style") == "display: none;" ){
          $(this).addClass('expanded');
          $(this).removeClass('collapsed');}
      else {
          $(this).addClass('collapsed');
          $(this).removeClass('expanded');
      }
      $(this).next("div.filter").slideToggle();
  });
});

function addStatus(filter){
  if(filter.next("div.filter").attr("style") == "display: none;" ){
    filter.addClass('collapsed');
    filter.removeClass('expanded');
  }
  else{
    filter.addClass('expanded');
    filter.removeClass('collapsed');
  }
}
</script>


<div class='tab-container'>
 <ul class='etabs'>
   <li class='tab'><a href="{% url metashare.views.frontpage %}stats/top/">Statistics about visiting this META-SHARE node</a></li>
   <li class='tab tab-nobr'>Statistics about resource metadata</li>
   {% if user.username and myres %}
        <li class='tab'><a href="{% url metashare.views.frontpage %}stats/mystats/">My resources</a></li>
   {% endif %}
 </ul>
</div>

<div class="content_tab"> 
{% if usage_fields != None %}
    <table width=100% bgcolor="white" valign=top>
    <tr><td colspan=2>
        <form id="getusagestats" action="." method="POST"><font size=-1>Found <font size=+1>{{ fields_count }}</font> metadata</font><br>           
            Filter by: &nbsp;
            {% for filter,counter in usage_filter.items %}
               &nbsp;<input type="checkbox" name=filter value="{{ filter }}" onClick="submit()"
               {% if filter in selected_filters or selected_filters|length == 0%}
                    checked
               {% endif %}     
               >
               <div class="coverage {{ filter }}">&nbsp; {{ filter }} &nbsp;</div>({{ counter }}) &nbsp;
            {% endfor %}
            <input type="hidden" name="class" id="classname" value="{{ selected_class }}">
            <input type="hidden" name="field" id="fieldname" value="{{ selected_field }}">
        </form>
        <hr>
        <div style="float: right"><a href="javascript:expandAll();">Expand all</a>
            | <a href="javascript:collapseAll();">Collapse all</a></div>

    </td></tr>
    {% if errors != None %}
        <tr><td colspan=2>
            <div id=warning class=warning>
            &nbsp; <img src="{{ MEDIA_URL }}css/sexybuttons/images/icons/silk/error.png"> &nbsp; {{ errors }} &nbsp;
            </div>
        </td></tr>
    {% endif %}
    
            
        <tr><td> 
        
        {% for class, fields in usage_fields.items %}
            <!-- used values table -->
            {% if selected_class == fields.0.7 %}
             <a name="fieldvalues"></a>
             {% if result != None and result|length > 0 %}
            <div id=fieldvalues class=fieldvalues>
             <table border=1 valign=top>
                <tr bgcolor=lightgray>
                    <th>[<a href="javascript:hidediv('fieldvalues');" title="Close"><img src="{{ MEDIA_URL }}css/sexybuttons/images/icons/silk/cross.png"></a>]  &nbsp; used values for {{ selected_class }}/{{ selected_field }} values</th>
                    <th style="align: left" nowrap>value<br>counter</th>
                    <th style="align: left">resources<br>counter</th>                    
                </tr>
                 
            {% for field in result %}
                <tr>
                <td>{{ field.0 }}</td>
                <td style="align: right">{{ field.2 }}</td>
                <td style="align: right">{{ field.1 }}</td>
                </tr>
            {% endfor %}
            </table>
            </div>
            {% endif %} 
            {% endif %} 
            <!-- end table -->
            
            <a name="{{ class.split|join:"_" }}"></a>
            <div id="{{ class.split|join:"_" }}" class="accordion"><a href="#" onclick="return false"><label class='component'>&nbsp;{{ class }}&nbsp;</label></a></div> 
            <div class="filter">
            {% for field in fields %}
                <div style="width:100%">
                {% if field.6 == "component" %}
                    &nbsp;&nbsp;&nbsp;<a href="javascript:scrollToAnchor('{{ field.2.split|join:"_" }}')"><label class='component'><img src="{{ MEDIA_URL }}css/sexybuttons/images/icons/silk/bullet_arrow_right.png">
                     {{ field.2 }}</label></a>
                {% else %}
                    &nbsp;&nbsp;
                    {% if field.5 > 0 %}
                        <a href="javascript:getvalues('{{ field.7 }}','{{ field.1 }}')" 
                        {% if selected_class == field.7 and selected_field == field.1 %}
                            class="addFilter"> 
                        {% else %}
                            class="deleteFilter"> 
                        {% endif %}
                        <label class="title pointer">&nbsp;{{ field.2 }}&nbsp;</label></a>
                    {% else %}
                        <label class="title indent">&nbsp;{{ field.2 }}&nbsp;</label>
                    {% endif %}
                   
                {% endif %}
                
                
                {% if field.3 == 1 %}
                      <div class="coverage required">
                {% else %}
                    {% if field.3 == 2 %}
                         <div class="coverage optional">
                    {% else %}
                        {% if field.3 == 3 %}
                            <div class="coverage recommended">
                        {% else %}
                            <div class="coverage never">
                        {% endif %}
                    {% endif %}
                {% endif %}
                {% if field.5 == 0 %}
                    &nbsp;<i>never used</i>&nbsp;
                {% else %}
                    &nbsp; {{ field.5 }}/{{ field.4 }} &nbsp;
                {% endif %}
                </div>
                
                </div>                
            {% endfor %}
             </div> <!-- end filter -->
             
        {% endfor %}
        </td>
    </tr>
    <table>
</div>

    <script>
    function scrollToAnchor(name) {
        window.location = "#"+name;
        setTimeout("window.scrollBy(0, -100)", 1);
        document.getElementById(name).click();
    }
    {% if selected_field != "" %}
        scrollToAnchor("fieldvalues");
    {% endif %}
    </script>
            
{% endif %} 
{% endblock %}
